"""Tests for vulnerability analyzer"""

from datetime import datetime, timezone
from unittest.mock import MagicMock, patch

import pytest

from provchain.data.cache import Cache
from provchain.data.db import Database
from provchain.data.models import PackageIdentifier, PackageMetadata
from provchain.interrogator.analyzers.vulnerability import VulnerabilityAnalyzer


@pytest.fixture
def vulnerability_analyzer():
    """Create vulnerability analyzer for testing"""
    db = Database(":memory:")
    cache = Cache(db)
    return VulnerabilityAnalyzer(cache=cache, db=db)


@pytest.fixture
def sample_package_metadata():
    """Create sample package metadata"""
    package = PackageIdentifier(ecosystem="pypi", name="test-package", version="1.0.0")
    return PackageMetadata(identifier=package, description="Test package")


def test_vulnerability_analyzer_init(vulnerability_analyzer):
    """Test vulnerability analyzer initialization"""
    assert vulnerability_analyzer is not None
    assert vulnerability_analyzer.name == "vulnerability"


def test_vulnerability_analyzer_no_vulnerabilities(vulnerability_analyzer, sample_package_metadata):
    """Test analyzer when no vulnerabilities are found"""
    # Mock OSV client to return empty list
    with patch("provchain.interrogator.analyzers.vulnerability.OSVClient") as mock_osv:
        mock_client = MagicMock()
        mock_client.__enter__ = MagicMock(return_value=mock_client)
        mock_client.__exit__ = MagicMock(return_value=None)
        mock_client.get_vulnerabilities_for_package.return_value = []
        mock_osv.return_value = mock_client

        result = vulnerability_analyzer.analyze(sample_package_metadata)

        assert result.analyzer == "vulnerability"
        assert result.risk_score == 0.0
        assert len(result.findings) == 0
        assert result.confidence > 0.5  # High confidence when no vulnerabilities


def test_vulnerability_analyzer_with_vulnerabilities(vulnerability_analyzer, sample_package_metadata):
    """Test analyzer when vulnerabilities are found"""
    from provchain.data.models import Vulnerability, RiskLevel

    # Create mock vulnerability
    vuln = Vulnerability(
        id="CVE-2023-12345",
        summary="Test vulnerability",
        details="Test details",
        severity=RiskLevel.HIGH,
        fixed_versions=["1.0.1"],
        patch_available=True,
        exploit_available=False,
        references=["https://example.com"],
    )

    with patch("provchain.interrogator.analyzers.vulnerability.OSVClient") as mock_osv:
        mock_client = MagicMock()
        mock_client.__enter__ = MagicMock(return_value=mock_client)
        mock_client.__exit__ = MagicMock(return_value=None)
        mock_client.get_vulnerabilities_for_package.return_value = [vuln]
        mock_osv.return_value = mock_client

        result = vulnerability_analyzer.analyze(sample_package_metadata)

        assert result.analyzer == "vulnerability"
        assert result.risk_score > 0.0
        assert len(result.findings) > 0
        assert any(f.id == "CVE-2023-12345" for f in result.findings)

