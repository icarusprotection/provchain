# Vulnerability Detection

ProvChain provides comprehensive vulnerability detection using the OSV.dev API and CVSS v3.1 scoring.

## Overview

The vulnerability detection system queries the OSV.dev database for known vulnerabilities in packages, calculates CVSS scores, and provides detailed remediation guidance.

## Features

- **OSV.dev Integration**: Automatic queries to the OSV.dev vulnerability database
- **CVSS v3.1 Scoring**: Industry-standard vulnerability scoring
- **Severity Classification**: Automatic classification as Critical, High, Medium, or Low
- **Patch Availability**: Detection of available patches and fixed versions
- **Exploit Detection**: Identification of publicly available exploits
- **Prioritization**: Filter vulnerabilities by severity level

## Usage

### Scan Requirements File

```bash
# Scan all packages in requirements.txt
provchain vuln scan -r requirements.txt

# Output to JSON file
provchain vuln scan -r requirements.txt --format json -o vulnerabilities.json

# Filter by severity
provchain vuln scan -r requirements.txt --severity critical
```

### Check Specific Package

```bash
# Check a specific package version
provchain vuln check requests==2.31.0

# Check latest version
provchain vuln check requests

# Output in JSON format
provchain vuln check requests --format json
```

### Prioritize Vulnerabilities

```bash
# Show only critical vulnerabilities
provchain vuln prioritize -r requirements.txt --severity critical

# Show high and critical vulnerabilities
provchain vuln prioritize -r requirements.txt --severity high
```

## Output Formats

### Table Format (Default)

The table format provides a summary view with detailed vulnerability information:

```
Vulnerability Summary
┏━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━┳━━━━━━━━━┳━━━━━━┳━━━━━━━━┳━━━━┳━━━━━━━━━━━┓
┃ Package                 ┃ Total ┃ Critical ┃ High ┃ Medium ┃ Low ┃ Risk Score ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━╇━━━━━━━━━╇━━━━━━╇━━━━━━━━╇━━━━╇━━━━━━━━━━━┩
│ requests==2.31.0        │   3   │    1    │  1   │   1    │  0 │    9.2     │
└─────────────────────────┴───────┴─────────┴──────┴────────┴────┴────────────┘

Detailed Vulnerabilities:

requests==2.31.0
  CRITICAL CVE-2023-12345: Remote code execution vulnerability
    CVSS: 9.8 (CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H)
    Fixed in: 2.31.1
    ⚠ EXPLOIT AVAILABLE
    References: https://example.com/cve-2023-12345
```

### JSON Format

JSON output provides structured data for programmatic processing:

```json
[
  {
    "package": {
      "ecosystem": "pypi",
      "name": "requests",
      "version": "2.31.0"
    },
    "vulnerabilities": [
      {
        "id": "CVE-2023-12345",
        "summary": "Remote code execution vulnerability",
        "severity": "critical",
        "cvss_score": {
          "base_score": 9.8,
          "severity": "critical"
        },
        "fixed_versions": ["2.31.1"],
        "exploit_available": true,
        "patch_available": true
      }
    ],
    "total_count": 1,
    "critical_count": 1,
    "risk_score": 9.8
  }
]
```

## CVSS Scoring

ProvChain uses CVSS v3.1 (Common Vulnerability Scoring System) to calculate vulnerability severity:

- **Critical (9.0-10.0)**: Immediate action required
- **High (7.0-8.9)**: Should be addressed promptly
- **Medium (4.0-6.9)**: Should be addressed in next update cycle
- **Low (0.1-3.9)**: Consider addressing when convenient

CVSS scores consider:
- Attack vector (Network, Adjacent, Local, Physical)
- Attack complexity (Low, High)
- Privileges required (None, Low, High)
- User interaction (None, Required)
- Scope (Unchanged, Changed)
- Impact on Confidentiality, Integrity, and Availability

## Integration with Vet Command

Vulnerability detection is automatically included when running `provchain vet`:

```bash
# Vulnerability analysis is included in vet results
provchain vet requests

# The vulnerability analyzer runs alongside other analyzers
provchain vet -r requirements.txt
```

## Caching

Vulnerability data is cached locally to reduce API calls:
- Cache duration: 6 hours for vulnerability queries
- Cache location: SQLite database at `~/.provchain/provchain.db`
- Cache can be cleared by deleting the database file

## Error Handling

If the OSV.dev API is unavailable:
- The analyzer gracefully degrades
- Returns low confidence results
- Logs error information
- Continues with other analyzers

## Exit Codes

The `vuln` commands exit with:
- `0`: No vulnerabilities found, or all vulnerabilities are below threshold
- `1`: Critical or high severity vulnerabilities found (when using `--severity` filter)

This makes it suitable for CI/CD integration:

```bash
# Fail CI if critical vulnerabilities found
provchain vuln scan -r requirements.txt --severity critical
```

